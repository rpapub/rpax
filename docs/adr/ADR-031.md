# ADR-031: Use Makefile with PowerShell Core for Cross-Platform Development Tasks

**Status:** Accepted  
**Date:** 2024-01-01  
**Updated:** 2025-09-08

## Context

The rpax project needs a standardized way to execute common development tasks such as:
- Running test corpus parsing during development
- Cross-platform CI/CD operations (clean, test, build, lint)
- Consistent task execution across Windows development and Ubuntu GitHub runners
- Integration with the uv package management workflow

### Requirements Analysis

1. **Cross-platform compatibility**: Must work on both Windows (development) and Ubuntu (GitHub Actions)
2. **Integration with uv**: Leverage `uv run` for Python execution
3. **Path handling**: Handle Windows absolute paths for corpus projects while supporting cross-platform CI tasks
4. **Industry standard**: Use widely adopted tooling that developers expect
5. **Future extensibility**: Support additional CI/CD tasks as the project grows

### Considered Options

1. **uv scripts in pyproject.toml**: Python-native but limited flexibility for complex task dependencies
2. **PowerShell scripts (.ps1)**: Cross-platform with pwsh but not standard build tool convention
3. **just command runner**: Modern Make alternative but requires additional tooling installation
4. **Makefile with Unix commands**: Traditional but path separator issues on Windows
5. **Makefile with PowerShell Core commands**: Combines Make's structure with cross-platform pwsh

## Decision

We will use **Makefile with PowerShell Core (pwsh) commands** for development task automation.

### Key Implementation Details

- Set `SHELL := pwsh` in Makefile to use PowerShell Core for command execution
- Use PowerShell cmdlets (`Remove-Item`, `Get-ChildItem`) for cross-platform file operations
- Maintain Windows-specific corpus parsing targets alongside cross-platform CI tasks
- Integrate with `uv run` for Python execution consistency

## Rationale

### Why Makefile + PowerShell Core

1. **Cross-platform guarantee**: PowerShell Core 7.4 LTS is pre-installed on GitHub Ubuntu runners (2024)
2. **Path handling**: PowerShell automatically handles path separators across platforms
3. **Industry standard**: Makefile is expected tooling that developers know
4. **Flexibility**: Supports complex task dependencies and conditional logic
5. **Future-proof**: Can accommodate additional CI/CD tasks as project grows

### Why Not Alternatives

- **uv scripts**: Limited to simple command sequences, no dependency management between tasks
- **PowerShell scripts**: Lack standardized task orchestration and dependency relationships  
- **just**: Additional tooling requirement, less familiar to contributors
- **Unix commands**: Path separator issues on Windows development environment

## Implementation

### Makefile Structure

```makefile
# Use PowerShell Core for cross-platform compatibility
SHELL := pwsh
PYTHON := uv run
RPAX := $(PYTHON) -m rpax.cli

# Windows-specific development targets
parse-all-corpuses: parse-corpus-core1 parse-frozenchlorine ...

# Cross-platform CI/CD targets  
clean:
    $(RPAX) clear artifacts --confirm
    Remove-Item -Recurse -Force -ErrorAction SilentlyContinue build/

test:
    $(PYTHON) -m pytest

lint:
    $(PYTHON) -m ruff check .
    $(PYTHON) -m mypy src/
```

### Task Categories

1. **Development tasks**: Windows-specific corpus parsing using absolute paths
2. **CI/CD tasks**: Cross-platform operations using PowerShell cmdlets
3. **Build tasks**: Platform-agnostic Python operations via uv

## Consequences

### Positive

- **Consistent tooling**: Same Makefile works on Windows development and Ubuntu CI
- **Path handling**: No path separator issues with PowerShell's automatic handling
- **Extensible**: Easy to add new tasks for growing CI/CD requirements
- **Standard**: Developers expect Makefile for build automation
- **Integration**: Works seamlessly with existing uv workflow

### Negative

- **PowerShell dependency**: Requires PowerShell Core (though pre-installed on target platforms)
- **Learning curve**: Contributors need familiarity with PowerShell cmdlets
- **Windows bias**: Development-specific tasks assume Windows corpus locations

### Neutral

- **Tool choice**: Standardizes on Make + PowerShell combination for consistency

## Compliance

This ADR aligns with:
- **ADR-015**: Python Package Foundation (uv integration)
- **Development methodology**: CLAUDE.md structured development approach
- **Cross-platform requirements**: Support for both development and CI environments

## Future Considerations

- Monitor PowerShell Core version consistency across runner environments
- Consider abstracting corpus paths through environment variables for contributor flexibility  
- Evaluate additional Make targets for documentation generation and deployment tasks